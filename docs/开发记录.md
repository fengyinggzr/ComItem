# ComItem QML 插件开发记录

## 项目概述

ComItem 是一个 Qt QML 插件项目，提供自定义 UI 组件供其他 Qt 项目使用。插件支持：
- Qt Creator 设计器拖拽使用
- Debug/Release 双版本构建
- 自动安装到 Qt SDK 目录
- 支持 `find_package(ComItem)` 方式引用

## 开发环境

- **Qt 版本**: 6.8.2 MSVC2022 64-bit
- **Qt 安装路径**: `D:/Qt/Qt6.8/6.8.2/msvc2022_64/`
- **构建工具**: CMake + Visual Studio 2022
- **项目路径**: `D:/Gitee/ComItem/`

---

## 项目目录结构

```
ComItem/
├── CMakeLists.txt              # 主构建配置
├── qmldir                      # QML 模块定义文件
├── cpp/                        # C++ 源文件目录
│   ├── comitem.h/cpp           # ComItem 基础组件
│   ├── combutton.h/cpp         # ComButton 按钮组件
│   └── comprogressbar.h/cpp    # ComProgressBar 进度条组件
├── qml/                        # QML 组件目录
│   ├── ComItemControls.qml     # 基础控件
│   ├── ComCard.qml             # 卡片组件
│   ├── ComSwitch.qml           # 开关组件
│   ├── ComBadge.qml            # 徽章组件
│   └── ComAvatar.qml           # 头像组件
├── designer/                   # Qt Designer 元数据
│   ├── comitem.metainfo        # 组件设计器定义
│   └── images/                 # 设计器图标
├── cmake/                      # CMake 辅助文件
│   ├── ComItemConfig.cmake.in  # find_package 配置模板
│   └── copy_headers.cmake      # 头文件复制脚本
└── docs/                       # 文档目录
    └── 开发记录.md
```

---

## 文件复制映射表

构建完成后，文件会自动复制到 Qt SDK 目录。以下是详细的复制映射：

### 1. QML 模块目录
**目标路径**: `D:/Qt/Qt6.8/6.8.2/msvc2022_64/qml/ComItem/`

| 源文件位置 | 目标文件位置 | 说明 |
|-----------|-------------|------|
| `build/bin/ComItem.dll` | `qml/ComItem/ComItem.dll` | Release 版本后端库 |
| `build/bin/ComItemd.dll` | `qml/ComItem/ComItemd.dll` | Debug 版本后端库 |
| `build/lib/ComItem.lib` | `qml/ComItem/ComItem.lib` | Release 导入库 |
| `build/lib/ComItemd.lib` | `qml/ComItem/ComItemd.lib` | Debug 导入库 |
| `build/bin/ComItemplugin.dll` | `qml/ComItem/ComItemplugin.dll` | Release 插件 |
| `build/bin/ComItemplugind.dll` | `qml/ComItem/ComItemplugind.dll` | Debug 插件 |
| `build/lib/ComItemplugin.lib` | `qml/ComItem/ComItemplugin.lib` | Release 插件导入库 |
| `build/lib/ComItemplugind.lib` | `qml/ComItem/ComItemplugind.lib` | Debug 插件导入库 |
| `qmldir` | `qml/ComItem/qmldir` | 模块定义文件 |
| `build/qml/ComItem/ComItem.qmltypes` | `qml/ComItem/ComItem.qmltypes` | 类型信息文件 |

### 2. QML 文件
**源目录**: `D:/Gitee/ComItem/qml/`  
**目标目录**: `D:/Qt/Qt6.8/6.8.2/msvc2022_64/qml/ComItem/`

| 源文件 | 目标文件 |
|-------|---------|
| `qml/ComItemControls.qml` | `qml/ComItem/ComItemControls.qml` |
| `qml/ComCard.qml` | `qml/ComItem/ComCard.qml` |
| `qml/ComSwitch.qml` | `qml/ComItem/ComSwitch.qml` |
| `qml/ComBadge.qml` | `qml/ComItem/ComBadge.qml` |
| `qml/ComAvatar.qml` | `qml/ComItem/ComAvatar.qml` |

### 3. 头文件
**源目录**: `D:/Gitee/ComItem/cpp/`  
**目标目录**: `D:/Qt/Qt6.8/6.8.2/msvc2022_64/qml/ComItem/`

| 源文件 | 目标文件 |
|-------|---------|
| `cpp/comitem.h` | `qml/ComItem/comitem.h` |
| `cpp/combutton.h` | `qml/ComItem/combutton.h` |
| `cpp/comprogressbar.h` | `qml/ComItem/comprogressbar.h` |

> 注意：只复制 `.h` 头文件，不复制 `.cpp` 源文件

### 4. 设计器文件
**源目录**: `D:/Gitee/ComItem/designer/`  
**目标目录**: `D:/Qt/Qt6.8/6.8.2/msvc2022_64/qml/ComItem/designer/`

| 源文件 | 目标文件 |
|-------|---------|
| `designer/comitem.metainfo` | `qml/ComItem/designer/comitem.metainfo` |
| `designer/images/*` | `qml/ComItem/designer/images/*` |

### 5. Qt bin 目录（设计器依赖）
**目标路径**: `D:/Qt/Qt6.8/6.8.2/msvc2022_64/bin/`

| 源文件 | 目标文件 | 说明 |
|-------|---------|------|
| `build/bin/ComItem.dll` | `bin/ComItem.dll` | 供设计器加载插件时找到依赖 |
| `build/bin/ComItemd.dll` | `bin/ComItemd.dll` | Debug 版本 |

### 6. CMake 配置文件
**目标路径**: `D:/Qt/Qt6.8/6.8.2/msvc2022_64/lib/cmake/ComItem/`

| 源文件 | 目标文件 | 说明 |
|-------|---------|------|
| `build/ComItemConfig.cmake` | `lib/cmake/ComItem/ComItemConfig.cmake` | find_package 配置 |
| `build/ComItemConfigVersion.cmake` | `lib/cmake/ComItem/ComItemConfigVersion.cmake` | 版本配置 |

---

## 主要开发历程

### 1. 初始问题
- QQmlApplicationEngine 加载失败，找不到 `ComItemplugin.dll`
- 最初考虑静态加载，后改为动态库方式

### 2. 设计器支持
- 创建 `designer/comitem.metainfo` 定义组件
- 移除 qmldir 中的 `prefer` 指令，解决设计器加载问题
- 复制 `ComItem.dll` 到 Qt bin 目录解决依赖问题

### 3. Debug/Release 双版本
- 添加 `DEBUG_POSTFIX "d"` 支持 Debug 后缀
- 更新 CMake 配置文件支持双版本查找

### 4. 新增组件
- **C++ 组件**: ComButton (按钮), ComProgressBar (进度条)
- **QML 组件**: ComCard (卡片), ComSwitch (开关), ComBadge (徽章), ComAvatar (头像)

### 5. 目录重组
- 将 C++ 文件移至 `cpp/` 目录
- 将 QML 文件移至 `qml/` 目录
- 使用 `file(GLOB)` 自动扫描文件，无需手动列出

### 6. 跨平台兼容
- 创建 `cmake/copy_headers.cmake` 脚本复制头文件
- 避免使用 `cmake -E rm -f` 在 PowerShell 中的兼容性问题

---

## 构建命令

```powershell
# 配置项目
cmake -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_PREFIX_PATH="D:/Qt/Qt6.8/6.8.2/msvc2022_64"

# 构建 Debug 版本
cmake --build build --config Debug

# 构建 Release 版本
cmake --build build --config Release
```

---

## 使用方法

### 在其他项目中使用

**CMakeLists.txt**:
```cmake
find_package(Qt6 REQUIRED COMPONENTS Quick)
find_package(ComItem REQUIRED)

target_link_libraries(YourApp PRIVATE ComItem)
```

**QML 文件**:
```qml
import ComItem 1.0

ComButton {
    text: "Click Me"
    onClicked: console.log("Clicked!")
}

ComProgressBar {
    value: 50
}

ComCard {
    title: "Card Title"
    // ...
}
```

---

## 安装目录结构预览

```
D:/Qt/Qt6.8/6.8.2/msvc2022_64/
├── bin/
│   ├── ComItem.dll              # Release (供设计器依赖)
│   └── ComItemd.dll             # Debug
├── qml/ComItem/
│   ├── ComItem.dll              # Release 后端库
│   ├── ComItemd.dll             # Debug 后端库
│   ├── ComItem.lib
│   ├── ComItemd.lib
│   ├── ComItemplugin.dll        # Release 插件
│   ├── ComItemplugind.dll       # Debug 插件
│   ├── ComItemplugin.lib
│   ├── ComItemplugind.lib
│   ├── qmldir
│   ├── ComItem.qmltypes
│   ├── ComItemControls.qml
│   ├── ComCard.qml
│   ├── ComSwitch.qml
│   ├── ComBadge.qml
│   ├── ComAvatar.qml
│   ├── comitem.h
│   ├── combutton.h
│   ├── comprogressbar.h
│   └── designer/
│       ├── comitem.metainfo
│       └── images/
└── lib/cmake/ComItem/
    ├── ComItemConfig.cmake
    └── ComItemConfigVersion.cmake
```

---

*文档生成日期: 2025年12月30日*
